<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>6. Dezember ‚Äì Nikolaus im schweren Labyrinth</title>
<style>
  :root{
    --cell: 22px;     /* wird per JS dynamisch an Gr√∂√üe angepasst */
    --gap: 2px;
    --wall:#1e293b;
    --path:#f8fafc;
    --forest:#2e7d32;
    --house:#ffd54f;
  }
  html,body{margin:0;height:100%;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#eef6f0;}
  header,footer{padding:12px 10px;text-align:center}
  h1{margin:0 0 6px}
  .sub{opacity:.85}
  .wrap{display:grid;place-items:center;padding:10px}
  .frame{
    padding:12px;
    background: radial-gradient(120% 120% at 0% 0%, #3aa35744 0 40%, transparent 60%) ,
                radial-gradient(120% 120% at 100% 100%, #3aa35733 0 40%, transparent 60%),
                #d7f0da;
    border-radius:16px; box-shadow:0 10px 28px rgba(0,0,0,.12);
  }
  .maze{ display:grid; grid-template-columns:repeat(var(--cols), var(--cell)); grid-auto-rows:var(--cell); gap:var(--gap); }
  .cell{ width:var(--cell); height:var(--cell); border-radius:5px; display:grid; place-items:center; font-size:calc(var(--cell)*.62); user-select:none; }
  .wall{ background:var(--wall); }
  .path{ background:var(--path); }
  .forest{ background:var(--forest); color:#fff; }
  .goal{ background:var(--house); position:relative; }
  .goal::after{ content:"üè†"; position:absolute; inset:0; display:grid; place-items:center; font-size:calc(var(--cell)*.62); }
  .player{ position:relative; }
  .player::after{ content:"üéÖ"; }
  .hud{ display:grid; gap:10px; justify-items:center; margin-top:12px; }
  .legend{ display:inline-grid; grid-auto-flow:column; gap:10px; padding:8px 12px; background:#ffffffaa; border-radius:10px; }
  .legend .dot{ width:14px;height:14px;border-radius:4px;display:inline-block;margin-right:6px;vertical-align:middle}
  .controls{ display:grid; grid-template-areas:
      ". up ."
      "left center right"
      ". down ."; gap:8px; touch-action:manipulation; }
  .btn{ grid-area:center; width:56px;height:56px;border-radius:12px;border:1px solid #b8c1cc;background:#fff;font-size:22px; }
  .btn:active{ transform:translateY(1px); }
  .up{grid-area:up}.down{grid-area:down}.left{grid-area:left}.right{grid-area:right}
  .win{display:none; padding:10px 14px; background:#fff3cd; border:1px solid #ffe08a; border-radius:10px;}
  .bar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center}
  select,button.small{
    padding:6px 10px; border-radius:8px; border:1px solid #b8c1cc; background:#fff; font:inherit; cursor:pointer;
  }
</style>
</head>
<body>
<header>
  <h1>6. Dezember ‚Äì Nikolaus im schweren Labyrinth</h1>
  <div class="sub">Bringe den Nikolaus üéÖ vom Wald au√üen zum gelben Haus üè† in der Mitte.</div>
</header>

<main class="wrap">
  <div class="bar">
    <label>Schwierigkeit:
      <select id="size">
        <option value="31" selected>Schwer (31√ó31)</option>
        <option value="41">Sehr schwer (41√ó41)</option>
        <option value="25">Mittel (25√ó25)</option>
      </select>
    </label>
    <button class="small" id="regen">Neu erzeugen</button>
  </div>

  <div class="frame">
    <div id="maze" class="maze" aria-label="Labyrinth" role="grid" tabindex="0"></div>
  </div>

  <div class="hud">
    <div class="legend" aria-hidden="true">
      <span><span class="dot" style="background:var(--forest)"></span>Wald</span>
      <span><span class="dot" style="background:var(--path)"></span>Weg</span>
      <span><span class="dot" style="background:var(--wall)"></span>Wand</span>
      <span><span class="dot" style="background:var(--house)"></span>Ziel</span>
      <span>üéÖ Du</span>
    </div>

    <div class="controls" id="dpad" aria-label="Steuerkreuz">
      <button class="btn up" aria-label="Nach oben">‚ñ≤</button>
      <button class="btn left" aria-label="Nach links">‚óÄ</button>
      <button class="btn" aria-label="Zentrum" disabled>üéÖ</button>
      <button class="btn right" aria-label="Nach rechts">‚ñ∂</button>
      <button class="btn down" aria-label="Nach unten">‚ñº</button>
    </div>

    <div class="win" id="win">Geschafft! Merke dir den Buchstaben: <strong id="letter">N</strong></div>
  </div>
</main>

<footer><p><a href="index.html">Zur√ºck zum Kalender</a></p></footer>

<script>
/* ==============================
   MAZE GENERATOR (Backtracker)
   ============================== */
const FOREST = 2, WALL = 1, PATH = 0;
let GRID = 0, SIZE = 31; // innere, ungerade Anzahl
let grid, position, goal;

const mazeEl = document.getElementById('maze');
const sizeSel = document.getElementById('size');
const regenBtn = document.getElementById('regen');

sizeSel.addEventListener('change', () => { SIZE = parseInt(sizeSel.value,10); generateAndDraw(); });
regenBtn.addEventListener('click', generateAndDraw);

function generateAndDraw(){
  // GRID = inner size + 2 (√§u√üerer Wald-Ring)
  GRID = SIZE + 2;
  document.documentElement.style.setProperty('--cols', GRID);
  fitCellSize();
  ({grid, position, goal} = buildMaze(SIZE));
  draw();
  attachControls();
}

function fitCellSize(){
  // Dynamische Zellgr√∂√üe, damit das Labyrinth immer gut sichtbar bleibt
  const maxWidth = Math.min(window.innerWidth - 32, 1100);
  const maxCell = Math.floor((maxWidth) / GRID) - 1;
  const cell = Math.max(14, Math.min(28, maxCell));
  document.documentElement.style.setProperty('--cell', cell + 'px');
}
window.addEventListener('resize', fitCellSize);

function buildMaze(n){
  // n muss ungerade sein
  if (n % 2 === 0) n -= 1;

  // Arbeitsgitter f√ºr den Generator (nur innerer Bereich)
  const rows = n, cols = n;
  const carve = Array.from({length: rows}, (_,r) =>
    Array.from({length: cols}, _ => WALL)
  );

  // Hilfsfunktionen
  const inBounds = (r,c) => r>0 && c>0 && r<rows-1 && c<cols-1;

  // Startpunkt f√ºr Generator: oben mittig (nahe Eingang)
  let sr = 1, sc = Math.floor(cols/2);
  carve[sr][sc] = PATH;

  // Rekursiver Backtracker (iterativ)
  const stack = [[sr,sc]];
  const dirs = [[-2,0],[2,0],[0,-2],[0,2]];
  while (stack.length){
    const [r,c] = stack[stack.length-1];
    const neighbors = [];
    for (const [dr,dc] of dirs){
      const nr=r+dr, nc=c+dc;
      if (inBounds(nr,nc) && carve[nr][nc]===WALL){
        neighbors.push([nr,nc, dr/2, dc/2]); // Zwischenschritt
      }
    }
    if (neighbors.length){
      const pick = neighbors[Math.floor(Math.random()*neighbors.length)];
      const [nr,nc, mr,mc] = pick;
      carve[r+mr][c+mc] = PATH;
      carve[nr][nc] = PATH;
      stack.push([nr,nc]);
    } else {
      stack.pop();
    }
  }

  // Gro√ües Grid inkl. Wald-Ring bauen
  const big = Array.from({length: n+2}, (_,r) =>
    Array.from({length: n+2}, (_,c) => {
      if (r===0 || c===0 || r===n+1 || c===n+1) return FOREST; // Wald au√üen
      return carve[r-1][c-1]===WALL ? WALL : PATH;
    })
  );

  // Eingang unten dem Start √∂ffnen
  const entranceCol = Math.floor((n+2)/2);
  big[1][entranceCol] = PATH;

  // Ziel exakt in die Mitte (global) setzen
  const g = { r: Math.floor((n+2)/2), c: Math.floor((n+2)/2) };

  // Startposition: im Wald oben, vor dem Eingang
  const start = { r: 0, c: entranceCol };

  return { grid: big, position: start, goal: g };
}

/* ==============================
   RENDER & CONTROLS
   ============================== */
function draw(){
  mazeEl.innerHTML = '';
  for (let r=0; r<GRID; r++){
    for (let c=0; c<GRID; c++){
      const d = document.createElement('div');
      const v = grid[r][c];
      if (r===goal.r && c===goal.c) d.className = 'cell goal';
      else if (v===WALL) d.className = 'cell wall';
      else if (v===FOREST) d.className = 'cell forest';
      else d.className = 'cell path';

      if (r===position.r && c===position.c){
        d.classList.add('player');
        d.tabIndex = 0;
      }
      mazeEl.appendChild(d);
    }
  }
  focusPlayer();
}

function focusPlayer(){
  const p = mazeEl.querySelector('.player');
  if (p) p.focus({preventScroll:true});
}

function canMove(r,c){
  if (r<0||c<0||r>=GRID||c>=GRID) return false;
  if (grid[r][c]===WALL) return false;
  return true; // Weg oder Wald
}

function move(dr,dc){
  const nr = position.r + dr;
  const nc = position.c + dc;
  if (!canMove(nr,nc)) return;
  position = { r: nr, c: nc };
  draw();
  checkWin();
}

function checkWin(){
  if (position.r===goal.r && position.c===goal.c){
    document.getElementById('win').style.display = 'block';
    document.getElementById('letter').textContent = 'N';
    detachControls();
  }
}

function detachControls(){
  document.removeEventListener('keydown', keyHandler);
  mazeEl.removeEventListener('touchstart', onTouchStart, {passive:false});
  mazeEl.removeEventListener('touchend', onTouchEnd, {passive:false});
  up.onclick = down.onclick = left.onclick = right.onclick = null;
}

/* Keyboard */
function keyHandler(e){
  const k = e.key.toLowerCase();
  if (['arrowup','w'].includes(k))      move(-1,0);
  else if (['arrowdown','s'].includes(k)) move(1,0);
  else if (['arrowleft','a'].includes(k)) move(0,-1);
  else if (['arrowright','d'].includes(k)) move(0,1);
}

/* Touch (Swipe) */
let sx=0, sy=0, st=0;
const SWIPE_MIN=22, SWIPE_MAXT=600;
function onTouchStart(e){
  if (!e.touches || e.touches.length!==1) return;
  sx=e.touches[0].clientX; sy=e.touches[0].clientY; st=Date.now();
}
function onTouchEnd(e){
  const dt = Date.now()-st; if (dt>SWIPE_MAXT) return;
  const t = e.changedTouches && e.changedTouches[0]; if (!t) return;
  const dx=t.clientX-sx, dy=t.clientY-sy;
  if (Math.max(Math.abs(dx),Math.abs(dy))<SWIPE_MIN) return;
  if (Math.abs(dx)>Math.abs(dy)) move(0, dx>0?1:-1); else move(dy>0?1:-1, 0);
}

/* D-Pad */
const up    = document.querySelector('.up');
const down  = document.querySelector('.down');
const left  = document.querySelector('.left');
const right = document.querySelector('.right');

function attachControls(){
  document.addEventListener('keydown', keyHandler);
  mazeEl.addEventListener('touchstart', onTouchStart, {passive:false});
  mazeEl.addEventListener('touchend', onTouchEnd, {passive:false});
  up.onclick    = ()=>move(-1,0);
  down.onclick  = ()=>move(1,0);
  left.onclick  = ()=>move(0,-1);
  right.onclick = ()=>move(0,1);
}

/* Init */
generateAndDraw();
</script>
</body>
</html>
